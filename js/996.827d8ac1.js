"use strict";(self["webpackChunksanyue_imghub"]=self["webpackChunksanyue_imghub"]||[]).push([[996],{7996:function(e,t,o){o.r(t),o.d(t,{default:function(){return N}});var i=o(6768),s=o(4232),r=o(5130);const l={class:"public-browse"},n={class:"header"},a={class:"header-left"},c={class:"logo"},d={class:"header-center"},u={class:"breadcrumb"},h=["onClick"],m={class:"header-right"},p={class:"file-count"},v={key:0,class:"loading-container"},g={key:1,class:"error-container"},C={key:2,class:"gallery-container",ref:"galleryContainer"},w={key:0,class:"folders-section"},k={class:"folders-grid"},f=["onClick"],L={class:"folder-name"},y={class:"waterfall",ref:"waterfall"},b=["onClick"],F=["src","alt","onLoad"],I=["src","onLoadedmetadata"],E={key:2,class:"file-placeholder"},x={class:"overlay"},P={class:"overlay-actions"},T=["onClick"],X=["onClick"],$={ref:"loadTrigger",class:"load-trigger"},M={key:0,class:"loading-more"},H={key:1,class:"no-more"},z=["src"],D=["src"];function V(e,t,o,V,R,B){return(0,i.uX)(),(0,i.CE)("div",l,[(0,i.Lk)("header",n,[(0,i.Lk)("div",a,[(0,i.Lk)("span",c,(0,s.v_)(B.siteName),1)]),(0,i.Lk)("div",d,[(0,i.Lk)("div",u,[(0,i.Lk)("span",{class:"breadcrumb-item",onClick:t[0]||(t[0]=(...e)=>B.goToRoot&&B.goToRoot(...e))},(0,s.v_)(B.rootDirName),1),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(B.pathParts,(e,o)=>((0,i.uX)(),(0,i.CE)(i.FK,{key:o},[t[10]||(t[10]=(0,i.Lk)("span",{class:"breadcrumb-sep"},"/",-1)),(0,i.Lk)("span",{class:"breadcrumb-item",onClick:e=>B.goToPath(o)},(0,s.v_)(e),9,h)],64))),128))])]),(0,i.Lk)("div",m,[(0,i.Lk)("span",p,(0,s.v_)(R.totalCount)+" 个文件",1)])]),R.loading&&0===R.files.length?((0,i.uX)(),(0,i.CE)("div",v,[...t[11]||(t[11]=[(0,i.Lk)("div",{class:"loading-spinner"},null,-1),(0,i.Lk)("p",null,"加载中...",-1)])])):R.error?((0,i.uX)(),(0,i.CE)("div",g,[(0,i.Lk)("p",null,(0,s.v_)(R.error),1),R.canRetry?((0,i.uX)(),(0,i.CE)("button",{key:0,onClick:t[1]||(t[1]=(...e)=>B.loadFiles&&B.loadFiles(...e)),class:"retry-btn"},"重试")):(0,i.Q3)("",!0)])):((0,i.uX)(),(0,i.CE)("div",C,[B.folders.length>0?((0,i.uX)(),(0,i.CE)("div",w,[(0,i.Lk)("div",k,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(B.folders,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.name,class:"folder-card",onClick:t=>B.enterFolder(e.name)},[t[12]||(t[12]=(0,i.Lk)("div",{class:"folder-icon"},[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"})])],-1)),(0,i.Lk)("span",L,(0,s.v_)(B.getFolderName(e.name)),1)],8,f))),128))])])):(0,i.Q3)("",!0),(0,i.Lk)("div",y,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(B.columns,(e,o)=>((0,i.uX)(),(0,i.CE)("div",{key:o,class:"waterfall-column"},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(e,e=>((0,i.uX)(),(0,i.CE)("div",{key:e.name,class:"waterfall-item",onClick:t=>B.openPreview(e)},[(0,i.Lk)("div",{class:(0,s.C4)(["image-wrapper",{loaded:e.loaded}])},[B.isImage(e)?((0,i.uX)(),(0,i.CE)("img",{key:0,src:B.getFileUrl(e.name),alt:e.name,loading:"lazy",onLoad:t=>B.onImageLoad(t,e),onError:t[2]||(t[2]=(...e)=>B.handleImageError&&B.handleImageError(...e))},null,40,F)):B.isVideo(e)?((0,i.uX)(),(0,i.CE)("video",{key:1,src:B.getFileUrl(e.name),muted:"",loop:"",preload:"metadata",onLoadedmetadata:t=>B.onVideoLoad(t,e),onMouseenter:t[3]||(t[3]=e=>e.target.play()),onMouseleave:t[4]||(t[4]=e=>e.target.pause())},null,40,I)):((0,i.uX)(),(0,i.CE)("div",E,[...t[13]||(t[13]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13z"})],-1)])])),(0,i.Lk)("div",x,[(0,i.Lk)("div",P,[(0,i.Lk)("button",{class:"action-btn",onClick:(0,r.D$)(t=>B.copyLink(e.name),["stop"]),title:"复制链接"},[...t[14]||(t[14]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"})],-1)])],8,T),(0,i.Lk)("button",{class:"action-btn",onClick:(0,r.D$)(t=>B.downloadFile(e.name),["stop"]),title:"下载"},[...t[15]||(t[15]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})],-1)])],8,X)])])],2)],8,b))),128))]))),128))],512),(0,i.Lk)("div",$,[R.loading&&R.files.length>0?((0,i.uX)(),(0,i.CE)("div",M,[...t[16]||(t[16]=[(0,i.Lk)("div",{class:"loading-spinner-small"},null,-1),(0,i.Lk)("span",null,"加载中...",-1)])])):!R.hasMore&&B.mediaFiles.length>0?((0,i.uX)(),(0,i.CE)("div",H," 已加载全部 ")):(0,i.Q3)("",!0)],512)],512)),R.previewVisible?((0,i.uX)(),(0,i.CE)("div",{key:3,class:"preview-modal",onClick:t[9]||(t[9]=(...e)=>B.closePreview&&B.closePreview(...e))},[(0,i.Lk)("div",{class:"preview-content",onClick:t[8]||(t[8]=(0,r.D$)(()=>{},["stop"]))},[(0,i.Lk)("button",{class:"preview-close",onClick:t[5]||(t[5]=(...e)=>B.closePreview&&B.closePreview(...e))},[...t[17]||(t[17]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)])]),R.previewIndex>0?((0,i.uX)(),(0,i.CE)("button",{key:0,class:"preview-prev",onClick:t[6]||(t[6]=(...e)=>B.prevImage&&B.prevImage(...e))},[...t[18]||(t[18]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})],-1)])])):(0,i.Q3)("",!0),B.currentPreviewFile&&B.isImage(B.currentPreviewFile)?((0,i.uX)(),(0,i.CE)("img",{key:1,src:B.getFileUrl(B.currentPreviewFile.name),class:"preview-image"},null,8,z)):B.currentPreviewFile&&B.isVideo(B.currentPreviewFile)?((0,i.uX)(),(0,i.CE)("video",{key:2,src:B.getFileUrl(B.currentPreviewFile.name),controls:"",autoplay:"",class:"preview-video"},null,8,D)):(0,i.Q3)("",!0),R.previewIndex<B.mediaFiles.length-1?((0,i.uX)(),(0,i.CE)("button",{key:3,class:"preview-next",onClick:t[7]||(t[7]=(...e)=>B.nextImage&&B.nextImage(...e))},[...t[19]||(t[19]=[(0,i.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,i.Lk)("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})],-1)])])):(0,i.Q3)("",!0)])])):(0,i.Q3)("",!0)])}o(4114),o(8111),o(2489),o(7588),o(1701);var R=o(4373),B=o(8401),U={name:"PublicBrowse",data(){return{files:[],allowedDirs:[],rootDir:"",currentPath:"",totalCount:0,loading:!1,error:null,canRetry:!0,hasMore:!0,previewVisible:!1,previewIndex:0,observer:null,pageSize:24,columnCount:4,columnHeights:[0,0,0,0]}},computed:{...(0,B.L8)(["userConfig"]),siteName(){return this.userConfig?.siteTitle||"公开相册"},rootDirName(){return this.rootDir.split("/").filter(Boolean).pop()||"根目录"},pathParts(){if(!this.currentPath||!this.rootDir)return[];const e=this.currentPath.replace(this.rootDir,"").replace(/^\/+/,"");return e.split("/").filter(Boolean)},folders(){return this.files.filter(e=>e.isFolder)},mediaFiles(){return this.files.filter(e=>!e.isFolder)},columns(){const e=Array.from({length:this.columnCount},()=>[]);for(const t of this.mediaFiles){const o=t.columnIndex??0;o<this.columnCount?e[o].push(t):e[0].push(t)}return e},currentPreviewFile(){return this.mediaFiles[this.previewIndex]}},watch:{"$route.params.dir":{handler(){this.initFromRoute()}}},mounted(){this.initFromRoute(),this.setupIntersectionObserver(),this.updateColumnCount(),window.addEventListener("resize",this.updateColumnCount)},beforeUnmount(){this.observer&&this.observer.disconnect(),window.removeEventListener("resize",this.updateColumnCount)},methods:{updateColumnCount(){const e=window.innerWidth;let t;t=e<600?2:e<900?3:4,t!==this.columnCount&&(this.columnCount=t,this.columnHeights=new Array(this.columnCount).fill(0),this.mediaFiles.forEach(e=>{e.columnIndex=void 0,this.assignToColumn(e)}))},getShortestColumn(){let e=0,t=this.columnHeights[0];for(let o=1;o<this.columnCount;o++)this.columnHeights[o]<t&&(t=this.columnHeights[o],e=o);return e},assignToColumn(e,t=200){const o=this.getShortestColumn();e.columnIndex=o,this.columnHeights[o]+=t},onImageLoad(e,t){const o=e.target,i=o.naturalHeight/o.naturalWidth,s=280*i;void 0===t.columnIndex&&this.assignToColumn(t,s),t.loaded=!0},onVideoLoad(e,t){const o=e.target,i=o.videoHeight/o.videoWidth,s=280*i;void 0===t.columnIndex&&this.assignToColumn(t,s),t.loaded=!0},setupIntersectionObserver(){this.observer=new IntersectionObserver(e=>{const t=e[0];t.isIntersecting&&this.hasMore&&!this.loading&&this.loadMore()},{rootMargin:"200px"})},observeLoadTrigger(){this.$nextTick(()=>{this.$refs.loadTrigger&&this.observer&&this.observer.observe(this.$refs.loadTrigger)})},async initFromRoute(){const e=this.$route.params.dir||"",t=Array.isArray(e)?e.join("/"):e;if(!t)return this.error="请指定要浏览的目录，例如: /browse/landscape",void(this.canRetry=!1);const o=t.split("/").filter(Boolean);this.rootDir=o[0],this.currentPath=t,this.files=[],this.hasMore=!0,this.columnHeights=new Array(this.columnCount).fill(0),await this.loadFiles(),this.observeLoadTrigger()},async loadFiles(){this.loading=!0,this.error=null,this.canRetry=!0;try{const e=await R.A.get(`/api/public/list?dir=${encodeURIComponent(this.currentPath)}&count=${this.pageSize}`);e.data.allowedDirs&&(this.allowedDirs=e.data.allowedDirs);const t=(e.data.directories||[]).map(e=>({name:e,isFolder:!0})),o=(e.data.files||[]).map(e=>({name:e.name,isFolder:!1,metadata:e.metadata,columnIndex:void 0}));o.forEach(e=>this.assignToColumn(e)),this.files=[...t,...o],this.totalCount=e.data.totalCount||this.files.length,this.hasMore=this.mediaFiles.length<this.totalCount}catch(e){if(403===e.response?.status){const t=e.response?.data?.error||"";t.includes("disabled")?this.error="公开浏览功能未启用":t.includes("not allowed")||t.includes("No public")?this.error="该目录不允许公开访问":this.error="访问被拒绝",this.canRetry=!1}else this.error="加载失败，请重试"}finally{this.loading=!1}},async loadMore(){if(!this.loading&&this.hasMore){this.loading=!0;try{const e=this.mediaFiles.length,t=await R.A.get(`/api/public/list?dir=${encodeURIComponent(this.currentPath)}&start=${e}&count=${this.pageSize}`),o=(t.data.files||[]).map(e=>({name:e.name,isFolder:!1,metadata:e.metadata,columnIndex:void 0}));o.forEach(e=>this.assignToColumn(e)),this.files.push(...o),this.hasMore=this.mediaFiles.length<this.totalCount}catch(e){console.error("加载更多失败",e)}finally{this.loading=!1}}},enterFolder(e){const t=e.replace(/\/+$/,"");this.$router.push(`/browse/${t}`)},goToRoot(){this.$router.push(`/browse/${this.rootDir}`)},goToPath(e){const t=this.pathParts.slice(0,e+1),o=this.rootDir+(t.length?"/"+t.join("/"):"");this.$router.push(`/browse/${o}`)},getFolderName(e){return e.split("/").filter(Boolean).pop()||e},getFileUrl(e){return`${window.location.origin}/file/${e}`},isImage(e){const t=e.name.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(t)},isVideo(e){const t=e.name.split(".").pop().toLowerCase();return["mp4","webm","ogg","mov"].includes(t)},handleImageError(e){e.target.style.display="none"},copyLink(e){const t=this.getFileUrl(e);navigator.clipboard?.writeText(t).then(()=>{this.showToast("已复制")}).catch(()=>{const e=document.createElement("input");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showToast("已复制")})},showToast(e){const t=document.querySelector(".copy-toast");t&&t.remove();const o=document.createElement("div");o.className="copy-toast",o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},1500)},downloadFile(e){const t=document.createElement("a");t.href=this.getFileUrl(e),t.download=e.split("/").pop(),t.click()},openPreview(e){if(e.isFolder)return;const t=this.mediaFiles.findIndex(t=>t.name===e.name);t>=0&&(this.previewIndex=t,this.previewVisible=!0,document.body.style.overflow="hidden")},closePreview(){this.previewVisible=!1,document.body.style.overflow=""},prevImage(){this.previewIndex>0&&this.previewIndex--},nextImage(){this.previewIndex<this.mediaFiles.length-1&&this.previewIndex++}}},_=o(1241);const A=(0,_.A)(U,[["render",V],["__scopeId","data-v-4e7bd6d6"]]);var N=A}}]);
//# sourceMappingURL=996.827d8ac1.js.map