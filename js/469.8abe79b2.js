"use strict";(self["webpackChunksanyue_imghub"]=self["webpackChunksanyue_imghub"]||[]).push([[469],{9469:function(e,t,i){i.r(t),i.d(t,{default:function(){return g}});var n=i(6768),s=i(4232);const a={class:"waterfall-container",ref:"container"},o={class:"waterfall-grid"},h=["src","alt","onLoad"],r={key:0,class:"loading-text"};function l(e,t,i,l,u,c){return(0,n.uX)(),(0,n.CE)("div",a,[(0,n.Lk)("div",o,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(u.images,((e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,class:"image-item",style:(0,s.Tr)({left:e.column*u.columnWidth+"px",top:`${e.top}px`,width:`${u.columnWidth}px`,height:`${e.height}px`})},[(0,n.Lk)("img",{src:e.url,alt:"Image "+t,loading:"lazy",onLoad:i=>c.updateImageHeight(e,t)},null,40,h)],4)))),128))]),u.loading?((0,n.uX)(),(0,n.CE)("p",r,"加载中...")):(0,n.Q3)("",!0)],512)}i(4114);var u=i(782),c={data(){return{images:[],minWidth:250,columnCount:3,columnWidth:0,columns:[],loading:!1,observer:null,resizeTimeout:null}},mounted(){this.$nextTick((()=>{this.updateColumnCount(),window.addEventListener("resize",this.onResize)})),this.loadImages(),this.initObserver()},computed:{...(0,u.L8)(["credentials","adminUrlSettings","userConfig"])},beforeDestroy(){this.observer&&this.observer.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout((()=>{this.updateColumnCount()}),300)},initObserver(){this.observer||(this.observer=new IntersectionObserver((e=>{e[0]?.isIntersecting&&this.loadImages()}),{threshold:.5}),this.observeSecondLastRow())},updateColumnCount(){if(!this.$refs?.container)return;const e=this.$refs.container.clientWidth;this.columnCount=Math.max(1,Math.floor(e/this.minWidth)),this.columnWidth=e/this.columnCount,this.columns=new Array(this.columnCount).fill(0),this.reflowImages()},async reflowImages(){if(!this.images.length)return;const e=new Array(this.columnCount).fill(0),t=this.images.map((t=>{const i=this.getMinColumnIndex(e);return t.column=i,t.top=e[i],e[i]+=t.height,t}));this.columns=e,this.images=t},getMinColumnIndex(e){return e.indexOf(Math.min(...e))},observeSecondLastRow(){this.$nextTick((()=>{const e=this.getSecondLastRowImage();e&&this.observer.observe(e)}))},getSecondLastRowImage(){const e=this.$el.querySelectorAll(".image-item"),t=this.columnCount,i=Math.max(0,e.length-2*t),n=Array.from(e).slice(i,i+t);return n[n.length-1]||null},async loadImages(){if(console.log("加载中"),!this.loading){this.loading=!0,0===this.columnWidth&&this.updateColumnCount();try{const e=await this.fetchWithAuth("/api/manage/check",{method:"GET"}).then((e=>e.text())).then((e=>{if("true"==e||"Not using basic auth."==e)return this.fetchWithAuth(`/api/manage/list?start=${this.images.length}&count=20&random=true`,{method:"GET"});throw new Error("Unauthorized")})).then((e=>e.json())),t=await Promise.all(e.map((async e=>{let t=0,i="/file/"+e.name;if(e.height&&e.width){const i=e.height/e.width;t=this.columnWidth*i}else{let{height:e,width:n}=await this.loadImageSize(i);const s=e/n;t=this.columnWidth*s}return"TelegramNew"===e.metadata?.Channel?e.channelTag="TG":"CloudflareR2"===e.metadata?.Channel?e.channelTag="R2":"S3"===e.metadata?.Channel?e.channelTag="S3":e.channelTag="未知",{url:i,height:t,column:0,top:0,channelTag:e.channelTag}})));this.images.push(...t),await this.reflowImages()}catch(e){console.error(e),"Unauthorized"!==e.message&&this.$message.error("同步数据时出错，请检查网络连接")}finally{this.loading=!1,this.observeSecondLastRow()}}},updateImageHeight(e,t){this.$nextTick((()=>{const i=this.$el.querySelectorAll(".image-item img")[t];i&&(e.height=i.clientHeight,requestAnimationFrame((()=>{this.reflowImages()})))}))},loadImageSize(e){return new Promise(((t,i)=>{const n=new Image;n.onload=()=>{t({width:n.width,height:n.height})},n.onerror=i,n.src=e}))},async fetchWithAuth(e,t={}){this.credentials&&(t.headers={...t.headers,Authorization:`Basic ${this.credentials}`},t.credentials="include");const i=await fetch(e,t);if(401===i.status)throw this.$message.error("认证状态错误，请重新登录"),this.$router.push("/adminLogin"),new Error("Unauthorized");return i}}},m=i(1241);const d=(0,m.A)(c,[["render",l],["__scopeId","data-v-d323b6d2"]]);var g=d}}]);
//# sourceMappingURL=469.8abe79b2.js.map