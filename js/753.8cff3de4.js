"use strict";(self["webpackChunksanyue_imghub"]=self["webpackChunksanyue_imghub"]||[]).push([[753],{2753:function(e,i,t){t.r(i),t.d(i,{default:function(){return q}});var s=t(6768),o=t(4232),r=t(5130);const n={class:"public-browse"},l={class:"header"},a={class:"header-left"},c={class:"logo"},d={class:"header-center"},h={class:"breadcrumb"},u=["onClick"],m={class:"header-right"},v={class:"file-count"},p={key:0,class:"loading-container"},g={key:1,class:"error-container"},w={key:2,class:"gallery-container",ref:"galleryContainer"},C={key:0,class:"folders-section"},k={class:"folders-grid"},f=["onClick"],F={class:"folder-name"},L={class:"waterfall",ref:"waterfall"},y=["onClick"],b=["src","alt","onLoad"],I=["src","onLoadedmetadata"],x={key:2,class:"file-placeholder"},E={class:"overlay"},T={class:"overlay-actions"},X=["onClick"],P=["onClick"],M={ref:"loadTrigger",class:"load-trigger"},S={key:0,class:"loading-more"},$={key:1,class:"no-more"},D={class:"carousel-slide"},z=["src"],H=["src"],V={class:"carousel-slide"},U=["src"],A=["src"],R={class:"carousel-slide"},B=["src"],_=["src"],Q={class:"page-indicator"};function j(e,i,t,j,N,O){return(0,s.uX)(),(0,s.CE)("div",n,[(0,s.Lk)("header",l,[(0,s.Lk)("div",a,[(0,s.Lk)("span",c,(0,o.v_)(O.siteName),1)]),(0,s.Lk)("div",d,[(0,s.Lk)("div",h,[(0,s.Lk)("span",{class:"breadcrumb-item",onClick:i[0]||(i[0]=(...e)=>O.goToRoot&&O.goToRoot(...e))},(0,o.v_)(O.rootDirName),1),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.pathParts,(e,t)=>((0,s.uX)(),(0,s.CE)(s.FK,{key:t},[i[13]||(i[13]=(0,s.Lk)("span",{class:"breadcrumb-sep"},"/",-1)),(0,s.Lk)("span",{class:"breadcrumb-item",onClick:e=>O.goToPath(t)},(0,o.v_)(e),9,u)],64))),128))])]),(0,s.Lk)("div",m,[(0,s.Lk)("span",v,(0,o.v_)(N.totalCount)+" 个文件",1)])]),N.loading&&0===N.files.length?((0,s.uX)(),(0,s.CE)("div",p,[...i[14]||(i[14]=[(0,s.Lk)("div",{class:"loading-spinner"},null,-1),(0,s.Lk)("p",null,"加载中...",-1)])])):N.error?((0,s.uX)(),(0,s.CE)("div",g,[(0,s.Lk)("p",null,(0,o.v_)(N.error),1),N.canRetry?((0,s.uX)(),(0,s.CE)("button",{key:0,onClick:i[1]||(i[1]=(...e)=>O.loadFiles&&O.loadFiles(...e)),class:"retry-btn"},"重试")):(0,s.Q3)("",!0)])):((0,s.uX)(),(0,s.CE)("div",w,[O.folders.length>0?((0,s.uX)(),(0,s.CE)("div",C,[(0,s.Lk)("div",k,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.folders,e=>((0,s.uX)(),(0,s.CE)("div",{key:e.name,class:"folder-card",onClick:i=>O.enterFolder(e.name)},[i[15]||(i[15]=(0,s.Lk)("div",{class:"folder-icon"},[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"})])],-1)),(0,s.Lk)("span",F,(0,o.v_)(O.getFolderName(e.name)),1)],8,f))),128))])])):(0,s.Q3)("",!0),(0,s.Lk)("div",L,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(O.columns,(e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"waterfall-column"},[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(e,e=>((0,s.uX)(),(0,s.CE)("div",{key:e.name,class:"waterfall-item",onClick:i=>O.openPreview(e)},[(0,s.Lk)("div",{class:(0,o.C4)(["image-wrapper",{loaded:e.loaded}])},[O.isImage(e)?((0,s.uX)(),(0,s.CE)("img",{key:0,src:O.getFileUrl(e.name),alt:e.name,loading:"lazy",onLoad:i=>O.onImageLoad(i,e),onError:i[2]||(i[2]=(...e)=>O.handleImageError&&O.handleImageError(...e))},null,40,b)):O.isVideo(e)?((0,s.uX)(),(0,s.CE)("video",{key:1,src:O.getFileUrl(e.name),muted:"",loop:"",preload:"metadata",onLoadedmetadata:i=>O.onVideoLoad(i,e),onMouseenter:i[3]||(i[3]=e=>e.target.play()),onMouseleave:i[4]||(i[4]=e=>e.target.pause())},null,40,I)):((0,s.uX)(),(0,s.CE)("div",x,[...i[16]||(i[16]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13z"})],-1)])])),(0,s.Lk)("div",E,[(0,s.Lk)("div",T,[(0,s.Lk)("button",{class:"action-btn",onClick:(0,r.D$)(i=>O.copyLink(e.name),["stop"]),title:"复制链接"},[...i[17]||(i[17]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"})],-1)])],8,X),(0,s.Lk)("button",{class:"action-btn",onClick:(0,r.D$)(i=>O.downloadFile(e.name),["stop"]),title:"下载"},[...i[18]||(i[18]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})],-1)])],8,P)])])],2)],8,y))),128))]))),128))],512),(0,s.Lk)("div",M,[N.loading&&N.files.length>0?((0,s.uX)(),(0,s.CE)("div",S,[...i[19]||(i[19]=[(0,s.Lk)("div",{class:"loading-spinner-small"},null,-1),(0,s.Lk)("span",null,"加载中...",-1)])])):!N.hasMore&&O.mediaFiles.length>0?((0,s.uX)(),(0,s.CE)("div",$," 已加载全部 ")):(0,s.Q3)("",!0)],512)],512)),N.previewVisible?((0,s.uX)(),(0,s.CE)("div",{key:3,class:"preview-modal",onClick:i[12]||(i[12]=(...e)=>O.handleModalClick&&O.handleModalClick(...e))},[(0,s.Lk)("button",{class:"preview-close",onClick:i[5]||(i[5]=(0,r.D$)((...e)=>O.closePreview&&O.closePreview(...e),["stop"]))},[...i[20]||(i[20]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)])]),(0,s.Lk)("div",{class:"carousel-container",onClick:i[6]||(i[6]=(0,r.D$)(()=>{},["stop"])),onTouchstartPassive:i[7]||(i[7]=(...e)=>O.onTouchStart&&O.onTouchStart(...e)),onTouchmove:i[8]||(i[8]=(...e)=>O.onTouchMove&&O.onTouchMove(...e)),onTouchend:i[9]||(i[9]=(...e)=>O.onTouchEnd&&O.onTouchEnd(...e))},[(0,s.Lk)("div",{class:"carousel-track",style:(0,o.Tr)(O.trackStyle)},[(0,s.Lk)("div",D,[O.prevPreviewFile&&O.isImage(O.prevPreviewFile)?((0,s.uX)(),(0,s.CE)("img",{key:0,src:O.getFileUrl(O.prevPreviewFile.name),class:"preview-image",draggable:"false"},null,8,z)):O.prevPreviewFile&&O.isVideo(O.prevPreviewFile)?((0,s.uX)(),(0,s.CE)("video",{key:1,src:O.getFileUrl(O.prevPreviewFile.name),muted:"",preload:"metadata",class:"preview-video"},null,8,H)):(0,s.Q3)("",!0)]),(0,s.Lk)("div",V,[O.currentPreviewFile&&O.isImage(O.currentPreviewFile)?((0,s.uX)(),(0,s.CE)("img",{key:0,src:O.getFileUrl(O.currentPreviewFile.name),class:"preview-image",draggable:"false"},null,8,U)):O.currentPreviewFile&&O.isVideo(O.currentPreviewFile)?((0,s.uX)(),(0,s.CE)("video",{key:1,src:O.getFileUrl(O.currentPreviewFile.name),controls:"",autoplay:"",class:"preview-video"},null,8,A)):(0,s.Q3)("",!0)]),(0,s.Lk)("div",R,[O.nextPreviewFile&&O.isImage(O.nextPreviewFile)?((0,s.uX)(),(0,s.CE)("img",{key:0,src:O.getFileUrl(O.nextPreviewFile.name),class:"preview-image",draggable:"false"},null,8,B)):O.nextPreviewFile&&O.isVideo(O.nextPreviewFile)?((0,s.uX)(),(0,s.CE)("video",{key:1,src:O.getFileUrl(O.nextPreviewFile.name),muted:"",preload:"metadata",class:"preview-video"},null,8,_)):(0,s.Q3)("",!0)])],4)],32),N.previewIndex>0?((0,s.uX)(),(0,s.CE)("button",{key:0,class:"preview-prev desktop-only",onClick:i[10]||(i[10]=(0,r.D$)((...e)=>O.prevImage&&O.prevImage(...e),["stop"]))},[...i[21]||(i[21]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})],-1)])])):(0,s.Q3)("",!0),N.previewIndex<O.mediaFiles.length-1?((0,s.uX)(),(0,s.CE)("button",{key:1,class:"preview-next desktop-only",onClick:i[11]||(i[11]=(0,r.D$)((...e)=>O.nextImage&&O.nextImage(...e),["stop"]))},[...i[22]||(i[22]=[(0,s.Lk)("svg",{viewBox:"0 0 24 24",fill:"currentColor"},[(0,s.Lk)("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})],-1)])])):(0,s.Q3)("",!0),(0,s.Lk)("div",Q,(0,o.v_)(N.previewIndex+1)+" / "+(0,o.v_)(O.mediaFiles.length),1)])):(0,s.Q3)("",!0)])}t(4114),t(8111),t(2489),t(7588),t(1701);var N=t(4373),O=t(8401),K={name:"PublicBrowse",data(){return{files:[],allowedDirs:[],rootDir:"",currentPath:"",totalCount:0,loading:!1,error:null,canRetry:!0,hasMore:!0,previewVisible:!1,previewIndex:0,observer:null,pageSize:24,columnCount:4,columnHeights:[0,0,0,0],touchStartX:0,touchStartY:0,touchCurrentX:0,isSwiping:!1,swipeOffset:0,isAnimating:!1,justTouched:!1}},computed:{...(0,O.L8)(["userConfig"]),siteName(){return this.userConfig?.siteTitle||"公开相册"},rootDirName(){return this.rootDir.split("/").filter(Boolean).pop()||"根目录"},pathParts(){if(!this.currentPath||!this.rootDir)return[];const e=this.currentPath.replace(this.rootDir,"").replace(/^\/+/,"");return e.split("/").filter(Boolean)},folders(){return this.files.filter(e=>e.isFolder)},mediaFiles(){return this.files.filter(e=>!e.isFolder)},columns(){const e=Array.from({length:this.columnCount},()=>[]);for(const i of this.mediaFiles){const t=i.columnIndex??0;t<this.columnCount?e[t].push(i):e[0].push(i)}return e},currentPreviewFile(){return this.mediaFiles[this.previewIndex]},prevPreviewFile(){return this.previewIndex>0?this.mediaFiles[this.previewIndex-1]:null},nextPreviewFile(){return this.previewIndex<this.mediaFiles.length-1?this.mediaFiles[this.previewIndex+1]:null},trackStyle(){const e=-100,i=this.swipeOffset/window.innerWidth*100,t=e+i;return{transform:`translateX(${t}%)`,transition:this.isSwiping?"none":"transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)"}}},watch:{"$route.params.dir":{handler(){this.initFromRoute()}}},mounted(){this.initFromRoute(),this.setupIntersectionObserver(),this.updateColumnCount(),window.addEventListener("resize",this.updateColumnCount)},beforeUnmount(){this.observer&&this.observer.disconnect(),window.removeEventListener("resize",this.updateColumnCount)},methods:{updateColumnCount(){const e=window.innerWidth;let i;i=e<600?2:e<900?3:4,i!==this.columnCount&&(this.columnCount=i,this.columnHeights=new Array(this.columnCount).fill(0),this.mediaFiles.forEach(e=>{e.columnIndex=void 0,this.assignToColumn(e)}))},getShortestColumn(){let e=0,i=this.columnHeights[0];for(let t=1;t<this.columnCount;t++)this.columnHeights[t]<i&&(i=this.columnHeights[t],e=t);return e},assignToColumn(e,i=200){const t=this.getShortestColumn();e.columnIndex=t,this.columnHeights[t]+=i},onImageLoad(e,i){const t=e.target,s=t.naturalHeight/t.naturalWidth,o=280*s;void 0===i.columnIndex&&this.assignToColumn(i,o),i.loaded=!0},onVideoLoad(e,i){const t=e.target,s=t.videoHeight/t.videoWidth,o=280*s;void 0===i.columnIndex&&this.assignToColumn(i,o),i.loaded=!0},setupIntersectionObserver(){this.observer=new IntersectionObserver(e=>{const i=e[0];i.isIntersecting&&this.hasMore&&!this.loading&&this.loadMore()},{rootMargin:"200px"})},observeLoadTrigger(){this.$nextTick(()=>{this.$refs.loadTrigger&&this.observer&&this.observer.observe(this.$refs.loadTrigger)})},async initFromRoute(){const e=this.$route.params.dir||"",i=Array.isArray(e)?e.join("/"):e;if(!i)return this.error="请指定要浏览的目录，例如: /browse/landscape",void(this.canRetry=!1);const t=i.split("/").filter(Boolean);this.rootDir=t[0],this.currentPath=i,this.files=[],this.hasMore=!0,this.columnHeights=new Array(this.columnCount).fill(0),await this.loadFiles(),this.observeLoadTrigger()},async loadFiles(){this.loading=!0,this.error=null,this.canRetry=!0;try{const e=await N.A.get(`/api/public/list?dir=${encodeURIComponent(this.currentPath)}&count=${this.pageSize}`);e.data.allowedDirs&&(this.allowedDirs=e.data.allowedDirs);const i=(e.data.directories||[]).map(e=>({name:e,isFolder:!0})),t=(e.data.files||[]).map(e=>({name:e.name,isFolder:!1,metadata:e.metadata,columnIndex:void 0}));t.forEach(e=>this.assignToColumn(e)),this.files=[...i,...t],this.totalCount=e.data.totalCount||this.files.length,this.hasMore=this.mediaFiles.length<this.totalCount}catch(e){if(403===e.response?.status){const i=e.response?.data?.error||"";i.includes("disabled")?this.error="公开浏览功能未启用":i.includes("not allowed")||i.includes("No public")?this.error="该目录不允许公开访问":this.error="访问被拒绝",this.canRetry=!1}else this.error="加载失败，请重试"}finally{this.loading=!1}},async loadMore(){if(!this.loading&&this.hasMore){this.loading=!0;try{const e=this.mediaFiles.length,i=await N.A.get(`/api/public/list?dir=${encodeURIComponent(this.currentPath)}&start=${e}&count=${this.pageSize}`),t=(i.data.files||[]).map(e=>({name:e.name,isFolder:!1,metadata:e.metadata,columnIndex:void 0}));t.forEach(e=>this.assignToColumn(e)),this.files.push(...t),this.hasMore=this.mediaFiles.length<this.totalCount}catch(e){console.error("加载更多失败",e)}finally{this.loading=!1}}},enterFolder(e){const i=e.replace(/\/+$/,"");this.$router.push(`/browse/${i}`)},goToRoot(){this.$router.push(`/browse/${this.rootDir}`)},goToPath(e){const i=this.pathParts.slice(0,e+1),t=this.rootDir+(i.length?"/"+i.join("/"):"");this.$router.push(`/browse/${t}`)},getFolderName(e){return e.split("/").filter(Boolean).pop()||e},getFileUrl(e){return`${window.location.origin}/file/${e}`},isImage(e){const i=e.name.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(i)},isVideo(e){const i=e.name.split(".").pop().toLowerCase();return["mp4","webm","ogg","mov"].includes(i)},handleImageError(e){e.target.style.display="none"},copyLink(e){const i=this.getFileUrl(e);navigator.clipboard?.writeText(i).then(()=>{this.showToast("已复制")}).catch(()=>{const e=document.createElement("input");e.value=i,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showToast("已复制")})},showToast(e){const i=document.querySelector(".copy-toast");i&&i.remove();const t=document.createElement("div");t.className="copy-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},1500)},downloadFile(e){const i=document.createElement("a");i.href=this.getFileUrl(e),i.download=e.split("/").pop(),i.click()},openPreview(e){if(e.isFolder)return;const i=this.mediaFiles.findIndex(i=>i.name===e.name);i>=0&&(this.previewIndex=i,this.previewVisible=!0,document.body.style.overflow="hidden")},closePreview(){this.previewVisible=!1,document.body.style.overflow=""},prevImage(){this.previewIndex>0&&this.previewIndex--},nextImage(){this.previewIndex<this.mediaFiles.length-1&&this.previewIndex++},handleModalClick(e){this.justTouched||this.closePreview()},onTouchStart(e){if(this.isAnimating)return;this.justTouched=!0;const i=e.touches[0];this.touchStartX=i.clientX,this.touchStartY=i.clientY,this.touchCurrentX=i.clientX,this.isSwiping=!1,this.swipeOffset=0},onTouchMove(e){if(this.isAnimating)return;const i=e.touches[0],t=i.clientX-this.touchStartX,s=i.clientY-this.touchStartY;if(!this.isSwiping&&Math.abs(t)>10&&Math.abs(t)>Math.abs(s)&&(this.isSwiping=!0),this.isSwiping){e.preventDefault(),this.touchCurrentX=i.clientX;let s=t;(0===this.previewIndex&&s>0||this.previewIndex===this.mediaFiles.length-1&&s<0)&&(s*=.3),this.swipeOffset=s}},onTouchEnd(){if(!this.isSwiping)return;const e=this.touchCurrentX-this.touchStartX,i=.2*window.innerWidth,t=Math.abs(e)/100;this.isSwiping=!1,this.isAnimating=!0,e<-i||e<-50&&t>.5?this.previewIndex<this.mediaFiles.length-1&&this.previewIndex++:(e>i||e>50&&t>.5)&&this.previewIndex>0&&this.previewIndex--,this.swipeOffset=0,setTimeout(()=>{this.isAnimating=!1,this.justTouched=!1},350)}}},W=t(1241);const Y=(0,W.A)(K,[["render",j],["__scopeId","data-v-093e0d46"]]);var q=Y}}]);
//# sourceMappingURL=753.8cff3de4.js.map